
model Organization {
  id          String   @id @default(cuid())
  name        String
  industry    String?
  keywords    String[] // Target keywords for this org
  regions     String[] // Target regions for this org
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  users       UserProfile[]
  competitors Competitor[]
  debriefs    Debrief[]
  fetchJobs   FetchJob[]
}

model UserProfile {
  id             String       @id @default(cuid())
  email          String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  role           String       @default("member") // "admin", "member"
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model Competitor {
  id          String   @id @default(cuid())
  name        String
  website     String?
  description String?
  industry    String?
  region      String?
  headquarters  String?
  employeeCount String?
  revenue       String?
  fundingStatus String?
  keyMarkets    String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  news        CompetitorNews[]

  @@unique([organizationId, name]) // Names must be unique per org
}

model CompetitorNews {
  id            String     @id @default(cuid())
  competitorId  String
  competitor    Competitor @relation(fields: [competitorId], references: [id], onDelete: Cascade)
  eventType     String
  date          DateTime
  title         String
  summary       String
  threatLevel   Int
  region        String?    // "North America" | "Europe" | "MENA" | "APAC" | "South America" | "Global"
  details       String     // JSON string with location, financial_value, partners, products
  sourceUrl     String     @unique
  isRead        Boolean    @default(false)
  isStarred     Boolean    @default(false)
  extractedAt   DateTime   @default(now())

  @@index([competitorId, date])
  @@index([eventType])
  @@index([threatLevel])
  @@index([isRead])
}

model Debrief {
  id          String   @id @default(cuid())
  content     String
  periodStart DateTime
  periodEnd   DateTime
  itemCount   Int
  generatedAt DateTime @default(now())
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model FetchJob {
  id              String   @id @default(cuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  status          String   @default("pending")  // pending, running, completed, error
  currentStep     String?  // e.g. "Fetching news for Mappedin"
  processed       Int      @default(0)
  total           Int      @default(0)
  error           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
